services:
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      target: base
    image: statguard-core
    environment:
      - CHOWN_USER=${UID:-1000}
      - CHOWN_GROUP=${GID:-1000}
    ports:
      - "80:80"
    volumes:
      - ./:/var/www/html/statguard

  validator:
    build:
      context: ./web
      dockerfile: Dockerfile
      target: validator
    image: statguard-validator # Imagen con PHP + R
    profiles: ["r-validation"]
    volumes:
      - ./:/var/www/html/statguard
    working_dir: /var/www/html/statguard
    command: ["php", "scripts/validate_with_r.php"]

  benchmark:
    build:
      context: ./web
      dockerfile: Dockerfile
      target: validator
    image: statguard-validator
    profiles: ["performance"]
    environment:
      - DEFAULT_COMMAND=php tests/BenchmarkStatGuard.php
    volumes:
      - ./:/var/www/html/statguard
    working_dir: /var/www/html/statguard
    # Al usar 'image' sin 'build', Docker usarÃ¡ la imagen generada por validator
    command: ["php", "tests/BenchmarkStatGuard.php", "report"]

  docs:
    image: phpdocumentor/phpdocumentor
    profiles: ["docs"]
    volumes:
      - ./:/var/www/html/statguard
    # Nota: phpdoc suele trabajar mejor si le das el path absoluto del contenedor
    command: ["phpdoc", "-d", "/var/www/html/statguard/src", "-t", "/var/www/html/statguard/docs/api"]

  mkdocs:
    image: squidfunk/mkdocs-material
    profiles: ["docs"]
    ports:
      - "8000:8000" # Vital para ver el sitio en el navegador
    volumes:
      - ./:/docs
    working_dir: /docs
    # Usamos 'serve' para desarrollo en vivo en lugar de 'build'
    entrypoint: ["/bin/sh", "-c"]
    command:
      - >-
        pip install --no-cache-dir mkdocs-static-i18n
        && mkdocs serve --dev-addr=0.0.0.0:8000